 
### 채팅 기능 요구사항 파악

* 기능 목적:
	* 게시글을 보고, 동행 요청/확정을 위하여 상대 회원과 조율하는 과정에서 채팅 기능 사용

* 요구사항:
	* 응답 지연이 낮은 일대일 실시간 채팅이 가능해야 한다.
	* 앱 어플리케이션에서 작동한다.
	* 받은 메세지가 실시간으로, 푸시 알림을 통해 사용자에게 전송된다.
		* 메세지를 전달받은 시점에 사용자가 앱을 실행중이지 않더라도 푸시 알림이 가야한다.
	* 기한(2/20) 내에 기능 구현을 <u>완성</u>해야 한다.

* 추가 고려사항:
	* 파일, 링크 첨부 가능성이 있는가?
	* 메세지 개당 길이 제한이 있는가?
	* 종단간 암호화(End-to-End Encryption)를 할 필요성이 있는가?
	* 읽음 표시 기능이 필요한가?
	* 접속 상태를 관리해야 하는가?
	* 그룹 채팅 기능이 가능한가? X
	* 하나의 계정으로 여러 단말에 동시 접속 지원이 가능한가?
	* 채팅 이력은 얼마나 보관되는가? (저장 기간)
	* 검색 기능, mention 기능을, 특정 메시지로 jump(답장하기 기능)하는 등의 무작위적 데이터 접근을 허용하는가? (데이터 계층에서 해당 기능을 제공해야 함)

	* 백엔드 팀 내 논의(2025.01.29, 카카오톡):
		* 구현 완성 자체가 최우선 사항
		* 추가 기능의 경우, 구현 완료 후 추가 고려해보는 방식으로 진행
			* 구현한다면, 파일(사진), 링크 첨부 기능부터 구현
		* 메세지 길이 제한, 분당 보낼 수 있는 횟수, 채팅 이력은 공부 후 설정해보는 것으로


### 설계
#### 어떤 통신 프로토콜을 사용할 것인가?
> WebSocket

#### 기초 설계
전체 아키텍처는 아래로 나뉜다.
* Stateless: 기존 CRUD API (HTTP 유지)
* Stateful: 채팅 API (WebSocket 사용하여 실시간 추적)
* 제3자 서비스 연동: 채팅 푸시 알림 (외부 Actor에 의존)

트래픽 규모가 작은 경우 위의 기능을 서버 한 대로 구현할 수 있다.
* 채팅 외 API 서버
* 채팅 서버: 클라이언트 사이에서 메세지 중계
* 접속상태 서버: 사용자 접속 여부 관리
* 알림 서버: 실시간 푸시 알림 전송
* 키-값 저장소: 채팅 이력 보관용
![](https://blog.kakaocdn.net/dn/54Rgf/btsJtwNFnvP/RQZ6ajvmTNCcODzAaB3Jb1/img.png)

#### DB
채팅 이력을 모두 사용자의 기기에 보관하고, 앱 삭제 시 모든 이력이 제거된다면 채팅 관련 DB를 관리할 필요가 없다. 그러나 데이터를 별도로 저장해두고 싶거나, 사용자의 앱 삭제와 무관하게 데이터를 계속 보관하고 싶다면 DB는 반드시 필요하다.

> 사용자 정보, 채팅방 데이터 등은 RDB에 두고, 채팅 이력 데이터는 NoSQL에서 관리한다.

왜?
* 채팅 이력 데이터는 빈번한 읽기 및 쓰기 작업이 일어난다. NoSQL, 즉 키-값 데이터베이스는 데이터 접근 지연시간이 낮다.
* NoSQL은 비동기적으로 데이터를 처리하기 때문에 데이터의 즉시성을 보장한다.
	* 즉 실시간 데이터 동기화에 유리하다.
	* 많은 NoSQL이 이벤트 기반 아키텍처를 사용하여 데이터 변경 사항을 실시간으로 처리한다. 쉽게 말해 데이터가 삽입되거나 수정될 때마다 이벤트를 발생시켜 즉각적으로 반응하게 만든다.
* NoSQL은 클러스터링 및 분산 구조로 인해 수평적으로 확장(서버 추가)하기 좋다.
* NoSQL은 대량의 데이터를 저장하는 데 최적화되어 있다. 대량의 채팅 이력을 저장할 때, NoSQL은 비용 효율적으로 데이터를 저장할 수 있다.
* RDB는 long tail 부분을 잘 처리하지 못한다.
	* long tail:
		* 특정 데이터 세트에서 주류를 이루는 항목(인기 있는 데이터) 외에, 상대적으로 적게 발생하는 많은 수의 항목들이 모여 전체의 상당 부분을 차지하는 현상
	* 채팅 이력 데이터에서의 long tail:
		* 상대적으로 적게 조회되거나 사용되는 데이터 항목(오래된 채팅 이력) → 쿼리 성능 고려해야 함
		* 비정형 데이터들(이미지, 링크)? → 저장할 수 있는 구조를 요함
* 페이스북, 디스코드 등의 대형 채팅 시스템도 키-값 저장소를 사용한다.


#### 상세 설계

* 1:1 채팅 메세지 처리 흐름
![[Pasted image 20250203210503.png]]

##### 추가 고려 사항에 대한 설계

- 하나의 계정으로 여러 단말에 동시 접속 지원이 가능하다면, 여러 단말 사이의 메세지를 동기화해줘야 한다. 이떄, 단말기마다 cur_max_message_id 를 들고 있음으로써 최신 정보를 유지시킬 수 있다.

##### DB

- 채팅 기능을 위한 NoSQL로 MongoDB, Redis, Cassandra 순으로 많이 사용되는 듯하다.


**NoSQL로 MongoDB**를 채택한다.


왜?

- MongoDB
    - JSON과 유사한 문서 기반 저장 방식을 사용하기 때문에 채팅 메시지와 같은 비정형 데이터를 저장하기에 적합하다.
    - 스키마 구조가 유연하기 때문에 미리 정의할 필요가 없고, 구조 변경이 쉽다.
    - 쓰기/읽기 성능이 좋다.
    - Spring Data MongoDB를 통해 JPA와 유사한 방식으로 데이터를 관리할 수 있기 떄문에 SpringBoot와의 호환성이 좋다.
    - 복잡한 트랜잭션 처리에는 약하기 때문에 주의해야 한다.
    - 대규모 데이터를 위해 성능 최적화가 필요하다.
- Redis
    - 인메모리 저장소의 한계가 있다. 메모리 용량이 제한적이기 때문에 양이 많은 채팅 이력을 관리하기 힘들다.
    - 복잡한 쿼리나 관계형 데이터 처리가 어렵다.
    - 짧은 시간 동안 유지해야 하는 채팅 메시지나 알림 데이터를 처리하는 데 적합하다.
- Cassandra
    - 쓰기 성능은 좋은데 읽기 성능이 낮다.
    - 복잡한 쿼리나 관계형 데이터 처리가 어렵다.
    - 학습 곡선이 높다.
    - 분산 환경에서 대규모 데이터를 처리할 수 있어 글로벌 서비스에 적합하다.